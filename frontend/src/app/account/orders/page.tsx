"use client";
import { useEffect, useState } from "react";
import orderService from "../../admin/services/OrderServices";
import "bootstrap/dist/css/bootstrap.min.css";
import Swal from "sweetalert2";

export default function AddressTable() {
    const [orders, setOrders] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [sortConfig, setSortConfig] = useState<{ key: string; direction: "asc" | "desc" } | null>(null);

    useEffect(() => {
        const userId = localStorage.getItem("userId");
        if (!userId) {
            setLoading(false);
            return;
        }
        fetchOrders(userId);
    }, []);

    const fetchOrders = async (userId: string) => {
        try {
            const data = await orderService.getOrdersByUserId(userId);
            const ordersWithDetails = data.orders.map((order: any) => ({
                ...order,
                details: data.orderDetails.filter((detail: any) => detail.id_order === order._id) || [],
            }));
            setOrders(ordersWithDetails);
        } catch (err) {
            console.error("L·ªói khi l·∫•y ƒë∆°n h√†ng:", err);
        } finally {
            setLoading(false);
        }
    };

    const cancelOrder = async (orderId: string) => {
        const result = await Swal.fire({
            title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?",
            text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "C√≥, h·ªßy ƒë∆°n!",
            cancelButtonText: "Kh√¥ng",
        });

        if (!result.isConfirmed) return;

        try {
            await orderService.updateOrderStatus(orderId, { order_status: "Canceled" });
            setOrders((prevOrders) =>
                prevOrders.map((order) =>
                    order._id === orderId ? { ...order, order_status: "Canceled" } : order
                )
            );
            Swal.fire("ƒê√£ h·ªßy!", "ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c h·ªßy.", "success");
        } catch (error) {
            console.error("L·ªói khi h·ªßy ƒë∆°n h√†ng:", error);
            Swal.fire("L·ªói!", "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.", "error");
        }
    };

    const sortedOrders = [...orders].sort((a, b) => {
        if (!sortConfig) return 0;
        const { key, direction } = sortConfig;
        const orderA = a[key];
        const orderB = b[key];

        if (orderA < orderB) return direction === "asc" ? -1 : 1;
        if (orderA > orderB) return direction === "asc" ? 1 : -1;
        return 0;
    });

    const requestSort = (key: string) => {
        let direction: "asc" | "desc" = "asc";
        if (sortConfig && sortConfig.key === key && sortConfig.direction === "asc") {
            direction = "desc";
        }
        setSortConfig({ key, direction });
    };

    if (loading) return <p>Loading...</p>;
    if (!orders.length) return <p>Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o!</p>;

    return (
        <div className="container mt-4">
            <h5 className="mb-3">üì¶ ƒê∆†N H√ÄNG C·ª¶A B·∫†N</h5>
            <table className="table table-striped table-bordered text-center ">
                <thead className="table-dark">
                    <tr>
                        <th onClick={() => requestSort("order_code")} style={{ cursor: "pointer" }}>M√£ ƒë∆°n h√†ng üîΩ</th>
                        <th>Ng√†y ƒë·∫∑t h√†ng</th>
                        <th>Kh√°ch h√†ng</th>
                        <th onClick={() => requestSort("order_status")} style={{ cursor: "pointer" }}>Tr·∫°ng th√°i üîΩ</th>
                        <th onClick={() => requestSort("total_amount")} style={{ cursor: "pointer" }}>T·ªïng ti·ªÅn üîΩ</th>
                        <th>Chi ti·∫øt ƒë∆°n h√†ng</th>
                        <th>H·ªßy ƒë∆°n(only Pedding)</th>
                    </tr>
                </thead>
                <tbody>
                    {sortedOrders.map((order) => (
                        <tr key={order._id}>
                            <td>{order.order_code || "N/A"}</td>
                            <td>{new Date(order.createdAt).toLocaleDateString("vi-VN")}</td>
                            <td>
                                {order.name} <br />
                                üìß {order.id_user?.email} <br />
                                üìû {order.phone}
                            </td>
                            <td>
                                <span className={`badge ${order.order_status === "Pending" ? "bg-warning" : order.order_status === "Shipped" ? "bg-primary" : order.order_status === "Delivered" ? "bg-success" : "bg-danger"}`}>
                                    {order.order_status}
                                </span>
                            </td>
                            <td>{order.total_amount?.toLocaleString("vi-VN")} VND</td>
                            <td>
                                {order.details.slice(0, 2).map((item: any, index: any) => (
                                    <div key={index} className="text-start">
                                        <strong>{item.id_product?.name || "S·∫£n ph·∫©m kh√¥ng x√°c ƒë·ªãnh"}</strong>
                                        <br />
                                        S·ªë l∆∞·ª£ng: {item.quantity} - Gi√°: {item.price?.toLocaleString("vi-VN")} VND
                                    </div>
                                ))}
                                {order.details.length > 2 && <button className="btn btn-sm btn-info mt-2">Xem th√™m</button>}
                            </td>
                            <td>
                                {order.order_status === "Pending" && (
                                    <button className="btn btn-danger btn-sm" onClick={() => cancelOrder(order._id)}>
                                        H·ªßy ƒë∆°n
                                    </button>
                                )}
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    );
}
